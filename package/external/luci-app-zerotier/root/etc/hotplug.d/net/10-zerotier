#!/bin/sh
. "$IPKG_INSTROOT"/lib/functions.sh

(printf '..%s..' "$INTERFACE" | grep -q zt) || exit 0

openwrt_network_auto_nat_enabled() {
	nat_enable="$(uci get zerotier.openwrt_network.nat)"
	[ "$nat_enable" = "1" ]
}

delete_previous_conf() {
	uci -q batch <<-EOF >/dev/null
delete network.$INTERFACE
commit network
delete firewall.zt_zone_$INTERFACE
delete firewall.zt_rule_allowInbound
delete firewall.zt_fwd_${INTERFACE}2lan
delete firewall.zt_fwd_${INTERFACE}2wan
delete firewall.zt_fwd_lan2${INTERFACE}
commit firewall
EOF
}

[ "$ACTION" = "remove" ] && {
	delete_previous_conf
	fw3 -q reload
	ubus call network reload
}

[ "$ACTION" = "add" ] || exit 0
[ -d "/sys/class/net/$INTERFACE" ] && {
		delete_previous_conf

		uci -q batch <<-EOF
set network.$INTERFACE=interface
set network.$INTERFACE.ifname=$INTERFACE
set network.$INTERFACE.proto=none
set network.$INTERFACE.device=$INTERFACE
commit network
EOF

	if openwrt_network_auto_nat_enabled; then
		port="$(uci get zerotier.openwrt_network.port)"
		[ -z "$port" ] && port=9993

		uci -q batch <<-EOF
add firewall zone
rename firewall.@zone[-1]=zt_zone_$INTERFACE
set firewall.@zone[-1].network=$INTERFACE
set firewall.@zone[-1].input=ACCEPT
set firewall.@zone[-1].output=ACCEPT
set firewall.@zone[-1].forward=ACCEPT
set firewall.@zone[-1].name=zerotier
set firewall.@zone[-1].masq=1
set firewall.@zone[-1].mtu_fix=1
add_list firewall.@zone[-1].device=$INTERFACE
commit firewall
add firewall rule
rename firewall.@rule[-1]=zt_rule_allowInbound
set firewall.@rule[-1].name='Allow-ZeroTier-Inbound'
set firewall.@rule[-1].src='*'
set firewall.@rule[-1].target='ACCEPT'
add_list firewall.@rule[-1].proto='all'
set firewall.@rule[-1].dest_port='$port'
commit firewall
add firewall forwarding
rename firewall.@forwarding[-1]=zt_fwd_${INTERFACE}2lan
set firewall.@forwarding[-1].src=zerotier
set firewall.@forwarding[-1].dest=lan
add firewall forwarding
rename firewall.@forwarding[-1]=zt_fwd_${INTERFACE}2wan
set firewall.@forwarding[-1].src=zerotier
set firewall.@forwarding[-1].dest=wan
add firewall forwarding
rename firewall.@forwarding[-1]=zt_fwd_lan2${INTERFACE}
set firewall.@forwarding[-1].src=lan
set firewall.@forwarding[-1].dest=zerotier
commit firewall
EOF
		fw3 -q reload ;
	fi
}
